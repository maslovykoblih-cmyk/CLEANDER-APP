<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DUSSMANN - ≈†KODA DOOSAN ‚Äî CLEANDER</title>

<!-- Supabase client (ESM) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script>
<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#f4f7fb;
    --card:#fff;
    --accent:#0b5f8f;
    --muted:#7a8a93;
    --shadow: 0 8px 24px rgba(7,18,29,0.06);
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;color:#14303a;padding:20px;}
  .container{max-width:1200px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:20px;margin:0;color:#0f3550}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=text], input[type=email], input[type=password], select{padding:8px 10px;border-radius:10px;border:1px solid #d6e6ef;font-size:14px;outline:none}
  button{padding:8px 10px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:white;font-size:13px}
  .small{padding:6px 8px;font-size:13px}
  .panel{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);margin-bottom:14px;border:1px solid rgba(3,36,60,0.03)}
  .week-controls{display:flex;gap:8px;align-items:center}
  .week-header{display:flex;gap:6px;margin-bottom:12px}
  .week-day-box{flex:1;text-align:center}
  .week-day{padding:10px 6px;background:#e9f4ff;border-radius:10px;font-weight:600;color:#08345a;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}
  .section-row{display:flex;flex-direction:column;background:#fff;border-radius:12px;padding:10px;gap:10px;border:1px solid rgba(3,36,60,0.03)}
  .section-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .section-title{font-weight:700;color:#0b4270}
  .section-person{font-style:italic;color:#2f6a8b;font-size:13px}
  .days-row{display:flex;gap:6px}
  .day-cell{flex:1;text-align:center;padding:8px 6px;border-radius:8px;font-size:12px;color:white;cursor:pointer;user-select:none;min-width:36px}
  .day-none{background:#eef3f6;color:var(--muted)}
  .day-waiting{background:#ffd86b;color:#3a2b00}
  .day-done{background:#5ce1a2;color:#064022}
  .day-bad{background:#ff8a85;color:#5b1516}
  .muted{color:var(--muted)}
  .center{display:flex;gap:8px;align-items:center}
  .form-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  label.small{font-size:13px;color:var(--muted)}
 .comment-toggle {
  background:#0b5f8f;
  color:white;
  padding:4px 8px;
  font-size:12px;
  border-radius:8px;
  cursor:pointer;
}

.comment-box {
  margin-top:10px;
  background:#f7fbff;
  border-radius:10px;
  padding:10px;
  display:none;
  border:1px solid #cfe4ff;
}

.comment-item {
  background:white;
  border-radius:8px;
  padding:8px;
  margin-bottom:6px;
  border-left:4px solid #0b5f8f;
}

.comment-item.complaint {
  border-left:4px solid #ff5757;
  background:#ffeaea;
}

.comment-author {
  font-size:12px;
  color:#555;
}

.comment-msg {
  margin-top:4px;
  font-size:14px;
}

.comment-form {
  display:flex;
  gap:6px;
  margin-top:8px;
}

.comment-form textarea {
  flex:1;
  border-radius:8px;
  padding:6px;
  font-size:14px;
  border:1px solid #c4d5e5;
}

.comment-form button {
  background:#0b5f8f;
  color:white;
}
 
 .badge{background:#eef6fb;padding:6px 8px;border-radius:8px;color:#0b4270;font-weight:600}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <h1>DUSSMANN ‚Äî ≈†KODA DOOSAN</h1>
        <div class="badge">CLEANDER</div>
      </div>

      <div class="controls">
        <div id="authArea" class="center">
          <input type="email" id="email" placeholder="Email" />
          <input type="password" id="password" placeholder="Heslo" />
          <button id="btnSignIn" class="small">P≈ôihl√°sit</button>
          <button id="btnSignOut" class="small" style="display:none;background:#666">Odhl√°sit</button>
        </div>
        <button id="btnExport" class="small">Export PDF</button>
      </div>
    </header>

    <section class="panel">
      <div class="week-controls" style="justify-content:space-between;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prevWeek" class="small">¬´ T√Ωden zpƒõt</button>
          <button id="nextWeek" class="small">T√Ωden vp≈ôed ¬ª</button>
          <div id="currentWeekLabel" style="margin-left:8px;font-weight:600;color:#0b4270"></div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div id="userInfo" class="muted" style="font-size:13px"></div>
        </div>
      </div>

      <div id="weekHeader" class="week-header" aria-hidden="true"></div>

      <div style="margin-top:10px" class="form-row">
        <input type="text" id="sectionName" placeholder="N√°zev √∫seku" />
        <input type="text" id="sectionPerson" placeholder="Osoba" />
        <label class="small">Dny:</label>
        <div id="dayCheckboxes" style="display:flex;gap:6px;align-items:center">
          <label><input type="checkbox" value="0" /> Po</label>
          <label><input type="checkbox" value="1" /> √öt</label>
          <label><input type="checkbox" value="2" /> St</label>
          <label><input type="checkbox" value="3" /> ƒåt</label>
          <label><input type="checkbox" value="4" /> P√°</label>
          <label><input type="checkbox" value="5" /> So</label>
          <label><input type="checkbox" value="6" /> Ne</label>
        </div>
        <button id="btnAddSection" class="small">P≈ôidat √∫sek</button>
      </div>
    </section>

    <main id="calendarContainer" class="grid"></main>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ---------- Supabase config (ponech tv≈Øj key/url) ----------
const SUPABASE_URL = 'https://ndkovjnkfybtxspzdbpk.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ka292am5rZnlidHhzcHpkYnBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjAzOTcsImV4cCI6MjA3NzU5NjM5N30.SUds0wMRrEJaYy5kuyud0ggQrKh6ZodSfmDwDybH4MI';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// povolen√≠ (po≈ô√°d lok√°lnƒõ - pole email≈Ø)
const allowedUsers = [
  "maslovykoblih@gmail.com",
  "kralmastah@gmail.com"
];

// ---------- Glob√°ln√≠ promƒõnn√© ----------
let user = null;
let sections = [];    // sections loaded from DB
let states = [];      // states for current week
let currentWeekStart = getMonday(new Date()); // Date object pondƒõl√≠

// ---------- DOM ready ----------
document.addEventListener('DOMContentLoaded', () => {
  // bind UI
  document.getElementById('btnSignIn').addEventListener('click', signIn);
  document.getElementById('btnSignOut').addEventListener('click', signOut);
  document.getElementById('btnAddSection').addEventListener('click', addSectionHandler);
  document.getElementById('prevWeek').addEventListener('click', ()=>{ changeWeek(-1); });
  document.getElementById('nextWeek').addEventListener('click', ()=>{ changeWeek(1); });
  document.getElementById('btnExport').addEventListener('click', exportPDF);

  // init auth/session
  initAuth();
});

// ---------- Auth & session ----------
async function initAuth(){
  try{
    const { data: { session }, error } = await supabase.auth.getSession();
    if(error) console.error('initAuth error', error);
    user = session?.user || null;
    updateAuthUI();
    // Listen to auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      user = session?.user || null;
      if(user && !allowedUsers.includes(user.email)){
        alert('Tento √∫ƒçet nem√° opr√°vnƒõn√≠!');
        supabase.auth.signOut();
        user = null;
      }
      updateAuthUI();
      loadAll();
    });
    // initial load
    loadAll();
  }catch(e){ console.error(e); }
}

function updateAuthUI(){
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userInfo = document.getElementById('userInfo');

  if(user){
    emailInput.style.display = 'none';
    passwordInput.style.display = 'none';
    btnSignIn.style.display = 'none';
    btnSignOut.style.display = 'inline-block';
    userInfo.textContent = `P≈ôihl√°≈°en: ${user.email}`;
  } else {
    emailInput.style.display = 'inline-block';
    passwordInput.style.display = 'inline-block';
    btnSignIn.style.display = 'inline-block';
    btnSignOut.style.display = 'none';
    userInfo.textContent = '';
  }
}

async function signIn(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!email || !password){ alert('Vypl≈à email i heslo'); return; }
  try{
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){ alert('Chyba p≈ôi p≈ôihl√°≈°en√≠: '+error.message); return; }
    if(!allowedUsers.includes(email)){
      alert('Tento √∫ƒçet nem√° opr√°vnƒõn√≠!');
      await supabase.auth.signOut();
      return;
    }
    user = data.user;
    updateAuthUI();
    await loadAll();
  }catch(e){ console.error(e); alert('Chyba p≈ôi p≈ôihl√°≈°en√≠'); }
}

async function signOut(){
  await supabase.auth.signOut();
  user = null;
  updateAuthUI();
  await loadAll();
}

// ---------- Load sections + states ----------
async function loadAll(){
  await loadSections();
  await loadStatesForWeek(currentWeekStart);
  render();
}

async function loadSections(){
  try{
    const { data, error } = await supabase
      .from('sections')
      .select('*')
      .order('id', {ascending:true});
    if(error){ console.error('loadSections', error); sections = []; return; }
    sections = (data || []).map(s => {
      // normalize days as array of ints
      let days = s.days;
      if(typeof days === 'string'){
        try{ days = JSON.parse(days); }catch(e){ days = []; }
      }
      return { ...s, days: Array.isArray(days) ? days.map(Number) : [] };
    });
  }catch(e){ console.error(e); sections = []; }
}

async function loadStatesForWeek(weekStartDate){
  try{
    const iso = toIsoDate(weekStartDate);
    const { data, error } = await supabase
      .from('states')
      .select('*')
      .eq('week_start', iso);
    if(error){ console.error('loadStatesForWeek', error); states = []; return; }
    states = data || [];
  }catch(e){ console.error(e); states = []; }
}

// ---------- Render ----------
function render(){
  renderWeekHeader();
  renderSections();
  document.getElementById('currentWeekLabel').textContent = formatWeekLabel(currentWeekStart);
}

function renderWeekHeader(){
  const header = document.getElementById('weekHeader');
  header.innerHTML = '';
  const daysCZ = ["Po","√öt","St","ƒåt","P√°","So","Ne"];
  for(let i=0;i<7;i++){
    const d = new Date(currentWeekStart);
    d.setDate(d.getDate() + i);
    const box = document.createElement('div'); box.className='week-day-box';
    const dayDiv = document.createElement('div'); dayDiv.className='week-day';
    if(new Date().toDateString()===d.toDateString()) dayDiv.style.boxShadow="inset 0 -4px 0 rgba(11,111,158,0.12)";
    dayDiv.innerText = `${daysCZ[i]} ${d.getDate()}.${d.getMonth()+1}`;
    box.appendChild(dayDiv);
    header.appendChild(box);
  }
}

function renderSections(){
  async function loadComments(sectionId){
  const { data, error } = await supabase
    .from("comments")
    .select("*")
    .eq("section_id", sectionId)
    .order("created_at", { ascending: true });

  return data || [];
}

function renderSections(){
  const container = document.getElementById('calendarContainer');
  container.innerHTML='';
  if(sections.length===0){
    const empty = document.createElement('div');
    empty.className='panel';
    empty.textContent = '≈Ω√°dn√© √∫seky. P≈ôidej √∫sek naho≈ôe.';
    container.appendChild(empty);
    return;
  }

  sections.forEach(sec=>{
    const secWrap = document.createElement('div'); 
    secWrap.className='panel section-row';

    // ========== HLAVICKA ==========
    const header = document.createElement('div'); 
    header.className='section-header';

    const left = document.createElement('div');
    const title = document.createElement('div'); 
    title.className='section-title'; 
    title.innerText = sec.name;

    const person = document.createElement('div'); 
    person.className='section-person'; 
    person.innerText = sec.person || '';

    left.appendChild(title);
    left.appendChild(person);

    const right = document.createElement('div');
    right.className='center';

    // BTN KOMENT√Å≈òE
    const btnComments = document.createElement('button');
    btnComments.className = 'small comment-toggle';
    btnComments.textContent = "üí¨ Koment√°≈ôe";
    right.appendChild(btnComments);

    // Pokud p≈ôihl√°≈°en ‚Üí Smazat
    if(user){
      const btnDel = document.createElement('button'); 
      btnDel.className='small'; 
      btnDel.style.background='#d9534f';
      btnDel.textContent = 'Smazat';
      btnDel.addEventListener('click', async ()=>{
        if(!confirm('Smazat √∫sek?')) return;
        await deleteSection(sec.id);
      });
      right.appendChild(btnDel);
    }

    header.appendChild(left);
    header.appendChild(right);
    secWrap.appendChild(header);

    // ========== DNY ==========
    const daysRow = document.createElement('div'); 
    daysRow.className='days-row';

    for(let dayIndex=0; dayIndex<7; dayIndex++){
      const cell = document.createElement('div'); 
      cell.className='day-cell day-none';

      const scheduled = (sec.days || []).includes(dayIndex);
      const stateObj = states.find(s => 
        s.section_id === sec.id && 
        Number(s.day_index) === dayIndex &&
        s.week_start === toIsoDate(currentWeekStart)
      );

      const state = stateObj ? stateObj.state : (scheduled ? 'waiting' : 'none');

      applyStateClass(cell, state);
      cell.dataset.sectionId = sec.id;
      cell.dataset.dayIndex = dayIndex;
      cell.dataset.state = state;

      cell.addEventListener('click', async ()=>{
        if(!user){ flashLoginNeeded(); return; }
        const current = cell.dataset.state || 'none';
        const next = nextState(current);
        cell.dataset.state = next;
        applyStateClass(cell, next);
        await upsertState(sec.id, dayIndex, next);
      });

      if(scheduled){
        cell.style.boxShadow = 'inset 0 -4px 0 rgba(11,111,158,0.06)';
      }

      const label = document.createElement('div');
      label.style.fontSize='12px';
      label.style.fontWeight='700';
      label.style.padding='6px 4px';
      label.innerText = dayShortName(dayIndex);

      cell.appendChild(label);
      daysRow.appendChild(cell);
    }

    secWrap.appendChild(daysRow);

    // ========== KOMENT√Å≈òE PANEL ==========
    const commentsBox = document.createElement('div');
    commentsBox.className = "comment-box";
    commentsBox.innerHTML = "<div>Naƒç√≠t√°m koment√°≈ôe...</div>";
    secWrap.appendChild(commentsBox);

    btnComments.addEventListener("click", async ()=>{
      commentsBox.style.display = 
        commentsBox.style.display === "none" ? "block" : "none";

      if(commentsBox.style.display === "block"){
        const comments = await loadComments(sec.id);

        commentsBox.innerHTML = "";

        comments.forEach(c=>{
          const item = document.createElement("div");
          item.className = "comment-item " + (c.is_complaint ? "complaint" : "");

          const author = document.createElement("div");
          author.className = "comment-author";
          author.textContent = c.author_email + " ‚Äî " + new Date(c.created_at).toLocaleString();

          const msg = document.createElement("div");
          msg.className = "comment-msg";
          msg.textContent = c.message;

          item.appendChild(author);
          item.appendChild(msg);
          commentsBox.appendChild(item);
        });

        // Formul√°≈ô pro nov√Ω koment√°≈ô
        if(user){
          const form = document.createElement("div");
          form.className = "comment-form";

          const textarea = document.createElement("textarea");
          textarea.placeholder = "Napi≈° koment√°≈ô...";

          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.title = "St√≠≈ænost";

          const btnSend = document.createElement("button");
          btnSend.textContent = "Odeslat";

          btnSend.addEventListener("click", async ()=>{
            const text = textarea.value.trim();
            if(!text) return;

            await supabase.from("comments").insert({
              section_id: sec.id,
              author_email: user.email,
              message: text,
              is_complaint: chk.checked
            });

            textarea.value = "";
            chk.checked = false;

            btnComments.click();
            btnComments.click();});
          form.appendChild(textarea);
          form.appendChild(chk);
          form.appendChild(btnSend);
          commentsBox.appendChild(form);}}});
    container.appendChild(secWrap);});}
  sections.forEach(sec=>{
    const secWrap = document.createElement('div'); secWrap.className='panel section-row';
    const header = document.createElement('div'); header.className='section-header';
    const left = document.createElement('div');
    const title = document.createElement('div'); title.className='section-title'; title.innerText = sec.name;
    const person = document.createElement('div'); person.className='section-person'; person.innerText = sec.person || '';
    left.appendChild(title);
    left.appendChild(person);
    const right = document.createElement('div');
    right.className='center';
    // edit & delete buttons (only if logged in)
    if(user){
      const btnDel = document.createElement('button'); btnDel.className='small'; btnDel.style.background='#d9534f';
      btnDel.textContent = 'Smazat';
      btnDel.addEventListener('click', async ()=>{
        if(!confirm('Smazat √∫sek?')) return;
        await deleteSection(sec.id);});
      right.appendChild(btnDel);}
    header.appendChild(left);
    header.appendChild(right);
    secWrap.appendChild(header);

    // days row
    const daysRow = document.createElement('div'); daysRow.className='days-row';
    for(let dayIndex=0; dayIndex<7; dayIndex++){
      const cell = document.createElement('div'); cell.className='day-cell day-none';
      // if section is scheduled this day, but not logged-in, show waiting by default
      const scheduled = (sec.days || []).includes(dayIndex);

      // find state for this section/day/this week
      const stateObj = states.find(s => s.section_id === sec.id && Number(s.day_index) === dayIndex && s.week_start === toIsoDate(currentWeekStart));
      const state = stateObj ? stateObj.state : (scheduled ? 'waiting' : 'none');

      applyStateClass(cell, state);
      cell.dataset.sectionId = sec.id;
      cell.dataset.dayIndex = dayIndex;
      cell.dataset.state = state;
      cell.title = scheduled ? 'Pl√°novan√Ω den' : 'Nepl√°novan√Ω den';

      // click handler: cycle states, only if logged in
      cell.addEventListener('click', async ()=>{
        if(!user){ flashLoginNeeded(); return; }
        // only allow manipulation if section exists (just safety)
        const current = cell.dataset.state || 'none';
        const next = nextState(current);
        cell.dataset.state = next;
        applyStateClass(cell, next);
        await upsertState(sec.id, dayIndex, next);});

      // visually indicate scheduled days (border)
      if(scheduled){
        cell.style.boxShadow = 'inset 0 -4px 0 rgba(11,111,158,0.06)';}

      // content: short label
      const label = document.createElement('div');
      label.style.fontSize='12px';
      label.style.fontWeight='700';
      label.style.padding='6px 4px';
      label.innerText = dayShortName(dayIndex);
      cell.appendChild(label);

      daysRow.appendChild(cell);
    }

    secWrap.appendChild(daysRow);
    container.appendChild(secWrap);
  });
}

// ---------- Helpers ----------
function applyStateClass(el, state){
  el.classList.remove('day-none','day-waiting','day-done','day-bad');
  if(state==='waiting') el.classList.add('day-waiting');
  else if(state==='done') el.classList.add('day-done');
  else if(state==='bad') el.classList.add('day-bad');
  else el.classList.add('day-none');
}

function nextState(current){
  if(current === 'none') return 'waiting';
  if(current === 'waiting') return 'done';
  if(current === 'done') return 'bad';
  return 'none';
}
function dayShortName(i){ return ['Po','√öt','St','ƒåt','P√°','So','Ne'][i]; }
function flashLoginNeeded(){
  const original = document.getElementById('authArea').style.boxShadow;
  document.getElementById('authArea').style.boxShadow = '0 0 0 3px rgba(255,165,0,0.18)';
  setTimeout(()=> document.getElementById('authArea').style.boxShadow = original, 800);
}
function formatWeekLabel(mondayDate){
  const d = new Date(mondayDate);
  const monday = `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
  d.setDate(d.getDate()+6);
  const sunday = `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
  return `${monday} ‚Äî ${sunday}`;
}
function getMonday(date){
  const d = new Date(date);
  const day = d.getDay() || 7;
  if(day !== 1) d.setDate(d.getDate() - day + 1);
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function toIsoDate(d){
  const dt = new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

// ---------- Week navigation ----------
async function changeWeek(delta){
  currentWeekStart.setDate(currentWeekStart.getDate() + delta*7);
  await loadStatesForWeek(currentWeekStart);
  render();
}

// ---------- Add / Delete sections ----------
async function addSectionHandler(){
  if(!user){ alert('Mus√≠≈° se p≈ôihl√°sit, aby ses mohl p≈ôid√°vat √∫seky'); return; }
  const name = document.getElementById('sectionName').value.trim();
  const person = document.getElementById('sectionPerson').value.trim();
  if(!name || !person){ alert('Vypl≈à n√°zev √∫seku i osobu'); return; }
  // collect checked days
  const checkboxes = Array.from(document.querySelectorAll('#dayCheckboxes input[type=checkbox]'));
  const days = checkboxes.filter(cb => cb.checked).map(cb => Number(cb.value));
  try{
    // insert into DB (store days as array)
    const { data, error } = await supabase
      .from('sections')
      .insert([{ name, person, days }])
      .select();
    if(error){ console.error('addSection error', error); alert('Chyba p≈ôi p≈ôid√°v√°n√≠'); return; }
    document.getElementById('sectionName').value='';
    document.getElementById('sectionPerson').value='';
    checkboxes.forEach(cb => cb.checked=false);
    await loadAll();
  }catch(e){ console.error(e); alert('Chyba p≈ôi p≈ôid√°n√≠ √∫seku'); }
}

async function deleteSection(sectionId){
  try{
    await supabase.from('sections').delete().eq('id', sectionId);
    // also delete related states
    await supabase.from('states').delete().match({ section_id: sectionId });
    await loadAll();
  }catch(e){ console.error(e); }
}

// ---------- Upsert state for a specific section/day/week ----------
async function upsertState(sectionId, dayIndex, state){
  // If state is 'none' and exists in DB => delete. Else upsert.
  const weekStartIso = toIsoDate(currentWeekStart);
  try{
    if(state === 'none'){
      await supabase.from('states').delete()
        .match({ section_id: sectionId, week_start: weekStartIso, day_index: dayIndex });
    } else {
      // upsert based on unique constraint (section_id, week_start, day_index)
      const payload = {
        section_id: sectionId,
        week_start: weekStartIso,
        day_index: dayIndex,
        state
      };
      const { error } = await supabase.from('states').upsert(payload, { onConflict: ['section_id','week_start','day_index'] });
      if(error) console.error('upsertState error', error);
    }
    // refresh local states
    await loadStatesForWeek(currentWeekStart);
  }catch(e){ console.error(e); }
}

// ---------- Export PDF (cel√° str√°nka) ----------
function exportPDF(){
  const wrapper = document.body; // export whole page
  html2canvas(wrapper, { scale: 2 }).then(canvas=>{
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p','pt','a4');
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save('uklidovy_kalendar.pdf');
  }).catch(e => console.error('exportPDF error', e));
}
</script>
</body>
</html>

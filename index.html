<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>DUSSMANN - ≈†KODA DOOSAN</title>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
import jsPDF from 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
import html2canvas from 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';

// ----- Supabase setup -----
const supabaseUrl = 'https://ndkovjnkfybtxspzdbpk.supabase.co';
const supabaseKey = 'TVUJ_SUPABeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ka292am5rZnlidHhzcHpkYnBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjAzOTcsImV4cCI6MjA3NzU5NjM5N30.SUds0wMRrEJaYy5kuyud0ggQrKh6ZodSfmDwDybH4MIASE_ANON_KEY';
const supabase = createClient(supabaseUrl, supabaseKey);

const days = ["Po","√öt","St","ƒåt","P√°","So","Ne"];
let sections = [];

/* ---------- HELPERS ---------- */
function ensureTaskDays(task){
  if(!task.days){
    task.days = Array(7).fill("day-waiting");
    return;
  }
  if(Array.isArray(task.days) && task.days.length===7 && typeof task.days[0]==="string") return;
  task.days = Array(7).fill("day-waiting");
}

function updateSectionSummary(sec, summaryDiv){
  let done=0, waiting=0, bad=0, comments=0;
  sec.tasks?.forEach(t=>{
    ensureTaskDays(t);
    t.days.forEach(s=>{
      if(s==="day-done") done++;
      else if(s==="day-bad") bad++;
      else if(s==="day-waiting") waiting++;
    });
    comments += (t.comments?.length||0);
  });
  summaryDiv.innerHTML = `<div class="small">Uklizeno: ${done}</div><div class="small">St√≠≈ænosti: ${comments}</div><div class="small">ƒåekaj√≠c√≠: ${waiting}</div><div class="small">≈†patnƒõ: ${bad}</div>`;
}

/* ---------- Supabase CRUD ---------- */
async function loadSections(){
  const { data, error } = await supabase.from('sections').select('*, tasks(*)').order('id');
  if(error){ console.error(error); return; }
  sections = data.map(s=>{ s.tasks = s.tasks||[]; return s; });
  render();
}

async function addSection(){
  const name = document.getElementById("sectionName").value.trim();
  const person = document.getElementById("sectionPerson").value.trim();
  if(!name||!person){ alert("Vypl≈à √∫sek a osobu!"); return; }
  const { data, error } = await supabase.from('sections').insert([{ name, person }]).select();
  if(error){ console.error(error); return; }
  data[0].tasks=[];
  sections.push(data[0]);
  document.getElementById("sectionName").value="";
  document.getElementById("sectionPerson").value="";
  render();
}

async function deleteSection(sId){
  if(!confirm("Opravdu smazat tento √∫sek?")) return;
  const { error } = await supabase.from('sections').delete().eq('id', sId);
  if(error){ console.error(error); return; }
  await loadSections();
}

async function addTask(sectionIdx, text, daysArr){
  const section = sections[sectionIdx];
  const { data, error } = await supabase.from('tasks')
    .insert([{ section_id: section.id, text, days: JSON.stringify(daysArr), comments: '[]' }])
    .select();
  if(error){ console.error(error); return; }
  section.tasks.push(data[0]);
  render();
}

async function deleteTask(sectionIdx, taskId){
  if(!confirm("Opravdu smazat √∫kol?")) return;
  const { error } = await supabase.from('tasks').delete().eq('id', taskId);
  if(error){ console.error(error); return; }
  await loadSections();
}

async function toggleTaskDay(sectionIdx, taskIdx, dayIdx){
  const task = sections[sectionIdx].tasks[taskIdx];
  ensureTaskDays(task);
  task.days[dayIdx] = task.days[dayIdx]==="day-waiting"?"day-done":task.days[dayIdx]==="day-done"?"day-bad":"day-waiting";
  const { error } = await supabase.from('tasks').update({ days: JSON.stringify(task.days) }).eq('id', task.id);
  if(error){ console.error(error); return; }
  render();
}

async function addTaskComment(sectionIdx, taskIdx, comment){
  const task = sections[sectionIdx].tasks[taskIdx];
  if(!task.comments) task.comments=[];
  task.comments.push(comment);
  const { error } = await supabase.from('tasks').update({ comments: JSON.stringify(task.comments) }).eq('id', task.id);
  if(error){ console.error(error); return; }
  render();
}

async function deleteTaskComment(sectionIdx, taskIdx, cIdx){
  const task = sections[sectionIdx].tasks[taskIdx];
  task.comments.splice(cIdx,1);
  const { error } = await supabase.from('tasks').update({ comments: JSON.stringify(task.comments) }).eq('id', task.id);
  if(error){ console.error(error); return; }
  render();
}

/* ---------- Render ---------- */
function renderWeekHeader(){
  const header = document.getElementById("weekHeader");
  header.innerHTML="";
  const today = new Date();
  const dayOfWeek = today.getDay()||7;
  const monday = new Date(today); monday.setDate(today.getDate()-dayOfWeek+1);
  for(let i=0;i<7;i++){
    const d=new Date(monday); d.setDate(monday.getDate()+i);
    const box=document.createElement("div"); box.className="week-day-box";
    const dayDiv=document.createElement("div"); dayDiv.className="week-day";
    if(new Date().toDateString()===d.toDateString()) dayDiv.style.boxShadow="inset 0 -4px 0 rgba(11,111,158,0.12)";
    dayDiv.innerText=`${days[i]} ${d.getDate()}.${d.getMonth()+1}`;
    box.appendChild(dayDiv);

    let done=0, waiting=0, bad=0;
    sections.forEach(sec=>sec.tasks?.forEach(t=>{
      ensureTaskDays(t);
      const state = t.days[i];
      if(state==="day-done") done++;
      else if(state==="day-bad") bad++;
      else if(state==="day-waiting") waiting++;
    }));

    const summaryDiv=document.createElement("div"); summaryDiv.className="week-day-summary";
    summaryDiv.innerText=`‚úÖ ${done}  ‚ö†Ô∏è ${bad}  ‚è≥ ${waiting}`;
    box.appendChild(summaryDiv);

    header.appendChild(box);
  }
}

function render(){
  renderWeekHeader();
  const container=document.getElementById("calendarContainer");
  container.innerHTML="";

  sections.forEach((sec,sIdx)=>{
    const secDiv=document.createElement("div"); secDiv.className="section";

    const header=document.createElement("div"); header.className="section-header";
    const left=document.createElement("div"); left.className="section-left";
    const title=document.createElement("div"); title.className="section-title"; title.innerText=sec.name||"(bez n√°zvu)";
    const person=document.createElement("div"); person.className="section-person"; person.innerText=sec.person||"(bez osoby)";
    left.appendChild(title); left.appendChild(person);
    header.appendChild(left);

    const actions=document.createElement("div"); actions.className="section-actions";
    const delBtn=document.createElement("button"); delBtn.className="small-btn"; delBtn.innerText="üóëÔ∏è";
    delBtn.addEventListener("click",()=>deleteSection(sec.id));
    actions.appendChild(delBtn); header.appendChild(actions);
    secDiv.appendChild(header);

    const summaryDiv=document.createElement("div"); summaryDiv.className="summary";
    updateSectionSummary(sec,summaryDiv);
    secDiv.appendChild(summaryDiv);

    const tasksDiv=document.createElement("div"); tasksDiv.className="tasks";
    sec.tasks?.forEach((task,tIdx)=>{
      ensureTaskDays(task);
      const taskDiv=document.createElement("div"); taskDiv.className="task";
      const taskHeader=document.createElement("div"); taskHeader.className="task-header";
      taskHeader.innerHTML=`<div class="task-text">${task.text}</div>`;
      const controls=document.createElement("div"); controls.className="task-controls";
      const delTask=document.createElement("button"); delTask.className="small-btn"; delTask.innerText="üóëÔ∏è";
      delTask.addEventListener("click",()=>deleteTask(sIdx,task.id));
      controls.appendChild(delTask); taskHeader.appendChild(controls);
      taskDiv.appendChild(taskHeader);

      const daysRow=document.createElement("div"); daysRow.className="task-days";
      task.days.forEach((state,dayIdx)=>{
        const cell=document.createElement("div"); cell.className="day-cell "+state;
        cell.addEventListener("click",()=>toggleTaskDay(sIdx,tIdx,dayIdx));
        daysRow.appendChild(cell);
      });
      taskDiv.appendChild(daysRow);

      const commentDiv=document.createElement("div"); commentDiv.className="comments";
      if(task.comments?.length>0) task.comments.forEach((c,idx)=>{
        const cItem=document.createElement("div"); cItem.className="comment-item";
        cItem.innerHTML=`<div>‚Ä¢ ${c}</div><div style="cursor:pointer;color:#b33;" onclick="deleteTaskComment(${sIdx},${tIdx},${idx})">‚ùå</div>`;
        commentDiv.appendChild(cItem);
      }); else commentDiv.innerText="≈Ω√°dn√© koment√°≈ôe";
      taskDiv.appendChild(commentDiv);

      const commentInput=document.createElement("input"); commentInput.type="text"; commentInput.placeholder="P≈ôidat koment√°≈ô";
      const commentBtn=document.createElement("button"); commentBtn.innerText="‚ûï";
      commentBtn.addEventListener("click",()=>{ if(commentInput.value.trim()!=="") addTaskComment(sIdx,tIdx,commentInput.value.trim()); commentInput.value=""; });
      taskDiv.appendChild(commentInput); taskDiv.appendChild(commentBtn);

      tasksDiv.appendChild(taskDiv);
    });

    // --- new task + day picker ---
    const newTaskDiv=document.createElement("div"); newTaskDiv.style.marginTop="10px"; newTaskDiv.style.display="flex"; newTaskDiv.style.flexDirection="column"; newTaskDiv.style.gap="8px";
    const newTaskRow=document.createElement("div"); newTaskRow.style.display="flex"; newTaskRow.style.gap="8px"; newTaskRow.style.alignItems="center";
    const newTaskInput=document.createElement("input"); newTaskInput.type="text"; newTaskInput.placeholder="Nov√Ω √∫kol"; newTaskInput.style.flex="1";
    const newTaskBtn=document.createElement("button"); newTaskBtn.innerText="‚ûï P≈ôidat √∫kol";
    newTaskBtn.addEventListener("click",()=>{
      const picks=Array.from(newTaskDiv.querySelectorAll(".day-pick"));
      const selected=picks.map((p,idx)=>p.classList.contains("active")?idx:-1).filter(i=>i>=0);
      const daysArr = selected.length===0 ? Array(7).fill("day-waiting") : Array(7).fill("day-none").map((_,i)=>selected.includes(i)?"day-waiting":"day-none");
      addTask(sIdx,newTaskInput.value.trim(),daysArr);
      newTaskInput.value=""; picks.forEach(p=>p.classList.remove("active"));
    });
    newTaskRow.appendChild(newTaskInput); newTaskRow.appendChild(newTaskBtn); newTaskDiv.appendChild(newTaskRow);
    const dayPicker=document.createElement("div"); dayPicker.className="day-picker";
    days.forEach((dname,idx)=>{
      const p=document.createElement("div"); p.className="day-pick"; p.innerText=dname;
      p.addEventListener("click",()=>p.classList.toggle("active"));
      dayPicker.appendChild(p);
    }); newTaskDiv.appendChild(dayPicker); tasksDiv.appendChild(newTaskDiv);

    secDiv.appendChild(tasksDiv); container.appendChild(secDiv);
  });
}

/* ---------- PDF Export ---------- */
window.exportPDF=()=>{ html2canvas(document.getElementById("calendarContainer")).then(canvas=>{
  const imgData=canvas.toDataURL("image/png"); const pdf=new jsPDF.jsPDF("p","pt","a4");
  const imgProps=pdf.getImageProperties(imgData); const pdfWidth=pdf.internal.pageSize.getWidth();
  const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
  pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight); pdf.save("uklidovy_kalendar.pdf");
});

/* ---------- Init ---------- */
window.addSection=addSection;
window.resetAll=async()=>{ if(confirm("Opravdu smazat v≈°e?")){ await supabase.from('tasks').delete(); await supabase.from('sections').delete(); await loadSections(); }};
loadSections();
</script>
</head>
<body>
<div class="container">
  <h1>DUSSMANN - ≈†KODA DOOSAN</h1>
  <div class="controls">
    <input type="text" id="sectionName" placeholder="N√°zev √∫seku">
    <input type="text" id="sectionPerson" placeholder="Osoba">
    <button onclick="addSection()">‚ûï P≈ôidat √∫sek</button>
    <button onclick="resetAll()" class="small-btn">Reset v≈°e</button>
    <button onclick="exportPDF()" class="small-btn">Export PDF</button>
  </div>
  <div id="weekHeader" class="week-header"></div>
  <div id="calendarContainer"></div>
</div>
<style>
/* --- v≈°echny tvoje CSS pravidla z p≈Øvodn√≠ho k√≥du --- */
</style>
</body>
</html>
